import { persistentAtom } from "@nanostores/persistent";

const defaultValue = {
  lineHeight: 1.8,
  fontSize: 16,
  maxWidth: 65, // å•ä½ä¸ºch
  alignJustify: false,
  fontFamily: "system-ui",
  titleFontSize: 1.6, // æ ‡é¢˜ç›¸å¯¹äºæ­£æ–‡å¤§å°çš„å€æ•°
  titleAlignType: "left",
  feedIconShape: "square", // circle, square
  useGrayIcon: false,
  sortDirection: "desc", // asc, desc
  sortField: "published_at", // published_at, created_at
  showHiddenFeeds: false,
  markAsReadOnScroll: false,
  cardImageSize: "large", // none, small, large
  showFavicon: true,
  titleLines: 2,
  textPreviewLines: 2,
  showReadingTime: true,
  autoHideToolbar: false,
  syncInterval: "15", // æ·»åŠ åŒæ­¥é—´éš”è®¾ç½®ï¼Œé»˜è®¤15åˆ†é’Ÿ
  showLineNumbers: false,
  forceDarkCodeTheme: false,
  defaultExpandCategory: false, // é»˜è®¤å±•å¼€åˆ†ç±»
  showUnreadByDefault: false,
  reduceMotion: false,
  interfaceFontSize: "16",
  showIndicator: true,
  floatingSidebar: false,
  // AI æ€»ç»“è®¾ç½®
  aiEnabled: false,
  aiEndpoint: "https://apingr.netlify.app/gemini/v1beta/openai/chat/completions",
  aiApiKey: "",
  aiModel: "gpt-4o-mini",
  aiTranslateModel: "", // ç¿»è¯‘ä¸“ç”¨æ¨¡å‹ï¼Œä¸ºç©ºæ—¶ä½¿ç”¨ aiModel
  // å¯ç”¨çš„æ‘˜è¦æç¤ºè¯ ID åˆ—è¡¨
  aiEnabledPrompts: ["default"],
  // é¢„è®¾æç¤ºè¯ï¼ˆä¸å¯åˆ é™¤ï¼Œå¯ç¦ç”¨ï¼‰
  aiPresetPrompts: [
    {
      id: "brief",
      name: "ğŸ“‹ ç®€æŠ¥",
      enabled: false,
      prompt: `**è¾“å‡ºè§„èŒƒ**: ç›´æ¥è¾“å‡ºç»“æœï¼Œä¸éœ€è¦å‰ç¼€è¯´æ˜æˆ–æ€»è¿°æ€§æ–‡å­—ã€‚ä½¿ç”¨ç®€ä½“ä¸­æ–‡å›å¤ã€‚

å°†è¿™ç¯‡æ–°é—»æ€»ç»“æˆç»“æ„åŒ–å†…å®¹ã€‚ç»„ç»‡æˆä»¥ä¸‹ç±»åˆ«ï¼šå…³é”®å†³ç­–ã€æ¶‰åŠäººç‰©ã€æ•°æ®è¦ç‚¹ã€å¾…è§‚å¯Ÿé—®é¢˜ã€‚ä¿æŒæ€»ç»“ç®€æ´ä¸“ä¸šã€‚è¡¨æ ¼è¾“å‡ºã€‚

æ³¨æ„ï¼šæ•°æ®è¦ç‚¹æŒ‰ç…§æŒ‰ç…§çŸ›ç›¾å’Œå†²çªå‰§çƒˆæ€§æ’åº`
    },
    {
      id: "data",
      name: "ğŸ“Š æ•°æ®æ€»ç»“",
      enabled: false,
      prompt: `**è¾“å‡ºè§„èŒƒ**: ç›´æ¥è¾“å‡ºç»“æœï¼Œä¸éœ€è¦å‰ç¼€è¯´æ˜æˆ–æ€»è¿°æ€§æ–‡å­—ã€‚ä½¿ç”¨ç®€ä½“ä¸­æ–‡å›å¤ã€‚

å°†è¿™ç¯‡æ–°é—»æ€»ç»“æˆç»“æ„åŒ–å†…å®¹ï¼Œä½¿ç”¨è¡¨æ ¼å‘ˆç°ï¼Œç»„ç»‡æˆä»¥ä¸‹ç±»åˆ«ï¼š

## ğŸ¯ å…³é”®å†³ç­–/äº‹ä»¶
| å†³ç­–/äº‹ä»¶ | å†…å®¹æ¦‚è¿° | é¢„æœŸå½±å“ |
|---------|---------|----------|
| [...]   | [...]   | [...]    |

## ğŸ‘¥ æ¶‰åŠäººç‰©/å®ä½“
| äººç‰©/å®ä½“ | èº«ä»½/è§’è‰² | å…³é”®è¡ŒåŠ¨/ç«‹åœº |
|------------|----------|----------------|
| [...]      | [...]    | [...]          |

## ğŸ“ˆ æ ¸å¿ƒæ•°æ®è¦ç‚¹
| æ•°æ®é¡¹ | å…·ä½“æ•°å€¼ | ç®€çŸ­è¯´æ˜ |
|---------|---------|----------|
| [...]   | [...]   | [...]    |

## ğŸ” å¾…è§‚å¯Ÿé—®é¢˜
| é—®é¢˜ | é‡è¦æ€§/å¯èƒ½å‘å±• |
|------|--------------------|
| [...] | [...]              |

ä¿æŒæ€»ç»“ç®€æ´ä¸“ä¸šï¼Œçªå‡ºæœ€å…³é”®çš„ä¿¡æ¯ã€‚`
    },
    {
      id: "default",
      name: "ğŸ“° æƒ…æŠ¥åˆ†æ",
      enabled: true,
      prompt: `**è¾“å‡ºè§„èŒƒ**: ç›´æ¥è¾“å‡ºç»“æœï¼Œä¸éœ€è¦å‰ç¼€è¯´æ˜æˆ–æ€»è¿°æ€§æ–‡å­—ã€‚ä½¿ç”¨ç®€ä½“ä¸­æ–‡å›å¤ã€‚

æ³¨æ„ï¼šä¸€ä¸ªè¡¨æ ¼è¾“å‡ºï¼Œæ³¨æ„æ¯ä¸ªæ ç›®è¦åˆ†è¡Œï¼ˆä½¿ç”¨<br>æ ‡ç­¾ï¼‰

## æ ¸å¿ƒé€»è¾‘é“¾
- **[èµ·å› ]**: ç®€è¿°å¼•å‘äº‹ä»¶çš„ç›´æ¥åŸå› æˆ–èƒŒæ™¯çŸ›ç›¾
- **[åŠ¨æ€]**: æ ¸å¿ƒäº‹ä»¶æ˜¯ä»€ä¹ˆï¼Œè°åšäº†ä»€ä¹ˆ
- **[å½±å“]**: äº‹ä»¶å¯¼è‡´çš„ç›´æ¥åæœæˆ–æ½œåœ¨è¶‹åŠ¿

## å…³é”®èƒŒæ™¯æ³¨è§£
- **[äººç‰©/å®ä½“åç§°]**: ä¸€å¥è¯è§£é‡Šèº«ä»½åŠå…³é”®ä½œç”¨
- **[åœ°ç¼˜/äº‹ä»¶æ¦‚å¿µ]**: ä¸€å¥è¯è§£é‡Šå®šä¹‰æˆ–å†å²èƒŒæ™¯

## å»¶ä¼¸æ€è€ƒ
- è¿™å¯¹ä¸­å›½/ä¸­å›½è¯»è€…æ„å‘³ç€ä»€ä¹ˆï¼Ÿ
- åç»­å¯èƒ½çš„å‘å±•èµ°å‘ï¼Ÿ`
    },
    {
      id: "academic",
      name: "ğŸ“ å­¦æœ¯é€‰é¢˜",
      enabled: false,
      prompt: `**è¾“å‡ºè§„èŒƒ**: ç›´æ¥è¾“å‡ºç»“æœï¼Œä¸éœ€è¦å‰ç¼€è¯´æ˜æˆ–æ€»è¿°æ€§æ–‡å­—ã€‚ä½¿ç”¨ç®€ä½“ä¸­æ–‡å›å¤ã€‚

ä½ æ˜¯ä¸€ä½é¡¶çº§åº”ç”¨ç»æµå­¦ä¸é‡‘èå­¦æœŸåˆŠçš„èµ„æ·±å­¦æœ¯ç¼–è¾‘ã€‚è¯·å°†è¿™ç¯‡æ–‡ç« è½¬åŒ–ä¸ºç»“æ„ä¸¥è°¨çš„å®è¯ç ”ç©¶æ¡†æ¶ã€‚

## æ ¸å¿ƒé€‰é¢˜æ¦‚è¿°
**ã€é¢˜ç›®æ„æ€ã€‘**ï¼š[ä¸€ä¸ªç¬¦åˆæœŸåˆŠé£æ ¼çš„æš‚å®šæ ‡é¢˜]
**ã€é€»è¾‘é“¾æ¡ã€‘**ï¼š
*   **æ ¸å¿ƒå˜é‡ (X)**ï¼š[æ–°é—»ä¸­çš„æ ¸å¿ƒå†²å‡»/äº‹ä»¶]
*   **ç»“æœå˜é‡ (Y)**ï¼š[å—å½±å“çš„ç»æµ/é‡‘èæŒ‡æ ‡]
*   **ä½œç”¨æœºåˆ¶ (M)**ï¼š[X æ˜¯å¦‚ä½•å¯¼è‡´ Y çš„ï¼Ÿ]
*   **æ’é™¤å‡è®¾**ï¼š[çœ‹ä¼¼åˆç†ä½†è¢«æ’é™¤çš„è§£é‡Š]

## è¯¦ç»†ç ”ç©¶é€»è¾‘
### 1. ç»æµå­¦ç›´è§‰ä¸æ•…äº‹çº¿
[è¯¦ç»†æè¿°èƒŒåçš„ç»æµå­¦åŸç†]

### 2. ç«äº‰æ€§å‡è®¾çš„æ’é™¤ç­–ç•¥
[ä¸ºä»€ä¹ˆä¼ ç»Ÿè§‚ç‚¹ä¸è¶³ä»¥è§£é‡Šå½“å‰ç°è±¡]

### 3. æœŸåˆŠé€‚é…æ€§
[è¯¥é€‰é¢˜ä¸ºä½•ç¬¦åˆé¡¶åˆŠé£æ ¼]`
    },
    {
      id: "vocabulary",
      name: "ğŸ“š éš¾è¯è§£æ",
      enabled: false,
      prompt: `**è¾“å‡ºè§„èŒƒ**: ç›´æ¥è¾“å‡ºç»“æœï¼Œä¸éœ€è¦å‰ç¼€è¯´æ˜æˆ–æ€»è¿°æ€§æ–‡å­—ã€‚ä½¿ç”¨ç®€ä½“ä¸­æ–‡å›å¤ã€‚

## ğŸ“– æ ¸å¿ƒæ¦‚å¿µè§£æ
å¯¹æ–‡ç« ä¸­æœ€é‡è¦çš„3-5ä¸ªæ¦‚å¿µè¿›è¡Œç»´åŸºç™¾ç§‘å¼çš„è¯¦è§£ï¼š
- **[æœ¯è¯­1]**: å®šä¹‰ã€èƒŒæ™¯ã€åœ¨æœ¬æ–‡ä¸­çš„å«ä¹‰
- **[æœ¯è¯­2]**: å®šä¹‰ã€èƒŒæ™¯ã€åœ¨æœ¬æ–‡ä¸­çš„å«ä¹‰

## ğŸ”¤ ä¸“ä¸šè¯æ±‡è¡¨
| è‹±æ–‡ | ä¸­æ–‡ | è§£é‡Š |
|------|------|------|
| term | è¯‘å | ç®€çŸ­è§£é‡Š |

## ğŸ’¡ å»¶ä¼¸é˜…è¯»å»ºè®®
- ç›¸å…³æ¦‚å¿µæˆ–èƒŒæ™¯çŸ¥è¯†æ¨è`
    },
    {
      id: "english",
      name: "ğŸ‡¬ğŸ‡§ è‹±è¯­å­¦ä¹ ",
      enabled: false,
      prompt: `**è¾“å‡ºè§„èŒƒ**: ç›´æ¥è¾“å‡ºç»“æœï¼Œä¸éœ€è¦å‰ç¼€è¯´æ˜æˆ–æ€»è¿°æ€§æ–‡å­—ã€‚ä½¿ç”¨ç®€ä½“ä¸­æ–‡å›å¤ã€‚

## ğŸ“ é«˜çº§è¯æ±‡ä¸è¡¨è¾¾
æå–æ–‡ç« ä¸­å€¼å¾—å­¦ä¹ çš„é«˜çº§è¯æ±‡å’Œåœ°é“è¡¨è¾¾ï¼š
| è¯æ±‡/çŸ­è¯­ | è¯æ€§ | ä¸­æ–‡é‡Šä¹‰ | ä¾‹å¥è¯­å¢ƒ |
|-----------|------|----------|----------|

## ğŸ“– å¥å‹åˆ†æ
åˆ†æ2-3ä¸ªå¤æ‚æˆ–ä¼˜ç¾çš„å¥å­ç»“æ„ï¼š
- **åŸå¥**: ...
- **ç»“æ„æ‹†è§£**: ...
- **ä»¿å†™å»ºè®®**: ...

## ğŸ—£ï¸ å®ç”¨è¡¨è¾¾
å¯ç”¨äºå£è¯­æˆ–å†™ä½œçš„åœ°é“è¡¨è¾¾ï¼š
- [è¡¨è¾¾1]: ä½¿ç”¨åœºæ™¯
- [è¡¨è¾¾2]: ä½¿ç”¨åœºæ™¯

## ğŸ“š ä¸»é¢˜è¯æ±‡æ‹“å±•
ä¸æœ¬æ–‡ä¸»é¢˜ç›¸å…³çš„è¯æ±‡ç½‘ç»œ`
    },
    {
      id: "fun",
      name: "ğŸ­ æœ‰è¶£ç†è§£",
      enabled: false,
      prompt: `ä½ æ˜¯ä¸€ä¸ªå–„äºç”¨å¹½é»˜æœ‰è¶£çš„æ–¹å¼è®²è§£å¤æ‚çŸ¥è¯†çš„é«˜æ‰‹ã€‚è¯·ç”¨è½»æ¾è¯™è°çš„è¯­è¨€é‡æ–°è§£è¯»è¿™ç¯‡æ–‡ç« ï¼Œè®©æ¯ç‡¥çš„æ–°é—»å˜å¾—ç”ŸåŠ¨æœ‰è¶£ã€ä»¤äººå°è±¡æ·±åˆ»ã€‚

## ğŸ¬ ä¸€å¥è¯ç¥æ€»ç»“
ç”¨ä¸€å¥è¯æ¦‚æ‹¬è¿™ç¯‡æ–‡ç« ï¼Œè¦æœ‰è¶£ã€çŠ€åˆ©ã€è®©äººå¿ä¸ä½æƒ³åˆ†äº«ã€‚

## ğŸª æ•…äº‹åŒ–è®²è§£
æŠŠæ–‡ç« çš„æ ¸å¿ƒå†…å®¹ç”¨è®²æ•…äº‹çš„æ–¹å¼è¯´å‡ºæ¥ï¼š
- å¯ä»¥ç”¨æ¯”å–»ã€ç±»æ¯”ã€è°ƒä¾ƒ
- å¯ä»¥è”ç³»ç”Ÿæ´»ä¸­çš„åœºæ™¯
- è®©è¯»è€…"å•Šå“ˆï¼åŸæ¥æ˜¯è¿™æ ·"

## ğŸ’¡ å…³é”®çŸ¥è¯†ç‚¹ï¼ˆè®°ä½è¿™ä¸‰æ¡å°±å¤Ÿäº†ï¼‰
1. **[è¦ç‚¹1]**: ç”¨å¤§ç™½è¯è®²æ˜ç™½
2. **[è¦ç‚¹2]**: ç”¨å¤§ç™½è¯è®²æ˜ç™½
3. **[è¦ç‚¹3]**: ç”¨å¤§ç™½è¯è®²æ˜ç™½

## ğŸ¤” çµé­‚æ‹·é—®
æå‡º1-2ä¸ªå¼•å‘æ€è€ƒçš„é—®é¢˜ï¼Œè®©è¯»è€…å¯¹è¿™ä¸ªè¯é¢˜äº§ç”Ÿæ›´æ·±çš„å…´è¶£

## ğŸ“¢ æœ‹å‹åœˆæ–‡æ¡ˆï¼ˆå¯ç›´æ¥å¤åˆ¶ï¼‰
å†™ä¸€æ®µé€‚åˆå‘æœ‹å‹åœˆçš„æ–‡æ¡ˆï¼Œåˆ†äº«è¿™ç¯‡æ–‡ç« çš„æœ‰è¶£è§‚ç‚¹`
    },

  ],
  // ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯
  aiCustomPrompts: [],
  // æ—§ç‰ˆå…¼å®¹
  aiSummaryPrompt: ``,
  // Memos è®¾ç½®
  memosEnabled: false,
  memosEndpoint: "https://memos.190904.xyz",
  memosToken: "",
  // ç¿»è¯‘è®¾ç½®
  translateEnabled: false,
  translateProvider: "ai", // 'ai' | 'google'
  targetLanguage: "zh",
  translateDisplayMode: "bilingual", // 'bilingual' | 'translated'
  translateConcurrency: 20, // ç¿»è¯‘å¹¶å‘æ•°
  autoTranslateEnglish: false, // è‡ªåŠ¨ç¿»è¯‘è‹±æ–‡å†…å®¹
  autoTranslatePriority: "google", // è‡ªåŠ¨ç¿»è¯‘ä¼˜å…ˆçº§: 'google' | 'ai'
  translateListItems: false, // ç¿»è¯‘åˆ—è¡¨æ ‡é¢˜å’Œæ‘˜è¦
  // MCP å…¨æ–‡æŠ“å–è®¾ç½®
  mcpEnabled: false,
  mcpEndpoint: "http://usa2.190904.xyz:8766/mcp",
  mcpAutoFetch: false, // å†…å®¹å°‘äº200å­—æ—¶è‡ªåŠ¨è·å–å…¨æ–‡
  autoTranslateAfterFetch: false, // è·å–å…¨æ–‡åè‡ªåŠ¨ç¿»è¯‘
  // ç¹ç®€è½¬æ¢è®¾ç½®ï¼ˆé»˜è®¤å¼€å¯ï¼‰
  t2sEnabled: true,
};

export const settingsState = persistentAtom("settings", defaultValue, {
  encode: (value) => {
    const filteredValue = Object.keys(value).reduce((acc, key) => {
      if (key in defaultValue) {
        acc[key] = value[key];
      }
      return acc;
    }, {});
    return JSON.stringify(filteredValue);
  },
  decode: (str) => {
    const storedValue = JSON.parse(str);
    const merged = { ...defaultValue, ...storedValue };

    // ç¡®ä¿æ–°çš„é¢„è®¾æç¤ºè¯è¢«æ·»åŠ åˆ°ç”¨æˆ·è®¾ç½®ä¸­
    if (defaultValue.aiPresetPrompts && merged.aiPresetPrompts) {
      const storedIds = merged.aiPresetPrompts.map(p => p.id);
      defaultValue.aiPresetPrompts.forEach(defaultPrompt => {
        if (!storedIds.includes(defaultPrompt.id)) {
          // æ–°çš„é¢„è®¾æç¤ºè¯ï¼Œæ·»åŠ åˆ°ç”¨æˆ·è®¾ç½®ä¸­
          merged.aiPresetPrompts.push(defaultPrompt);
        }
      });
    }

    return merged;
  },
});

export const updateSettings = (settingsChanges) =>
  settingsState.set({ ...settingsState.get(), ...settingsChanges });

export const resetSettings = () => {
  // å®šä¹‰é˜…è¯»ç›¸å…³çš„è®¾ç½®é¡¹
  const readingSettings = [
    "lineHeight",
    "fontSize",
    "maxWidth",
    "alignJustify",
    "fontFamily",
    "titleFontSize",
    "titleAlignType",
    "autoHideToolbar",
    "showLineNumbers",
    "forceDarkCodeTheme",
  ];
  const currentSettings = settingsState.get();
  const newSettings = { ...currentSettings };

  // åªé‡ç½®é˜…è¯»ç›¸å…³çš„è®¾ç½®
  readingSettings.forEach((key) => {
    newSettings[key] = defaultValue[key];
  });

  settingsState.set(newSettings);
};
